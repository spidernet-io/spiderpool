<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>Calico - spiderpool</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Calico";
        var mkdocs_page_input_path = "usage/install/overlay/get-started-calico.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> spiderpool
        </a>
        <div class="version">
          {'provider': 'mike'}
        </div><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Spiderpool</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Installation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../install/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Underlay installation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../underlay/get-started-calico/">Calico</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../underlay/get-started-weave/">Weave</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../underlay/get-started-kind/">Macvlan</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../underlay/get-started-ovs/">Ovs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../underlay/get-started-sriov/">SRIOV</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Overlay installation</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Calico</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../get-started-cilium/">Cilium</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Public cloud installation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../cloud/get-started-alibaba/">alibaba cloud</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../cloud/get-started-vmware/">vmware vsphere</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../cloud/get-started-openstack/">openstack</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../upgrade/">Upgrading</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../certificate/">Certificates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Usage</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../spider-subnet/">SpiderSubnet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../spider-multus-config/">SpiderMultusConfig</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ippool-namespace/">Default IPPool at namespace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../multi-interfaces-annotation/">Multiple interfaces</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ippool-multi/">Backup IPPool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ippool-affinity-namespace/">Namespace affinity of IPPool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ippool-affinity-node/">Node affinity of IPPool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ippool-affinity-pod/">Pod affinity of IPPool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ipv6/">IPv6 support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../statefulset/">StatefulSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../reserved-ip/">Reserved IP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../third-party-controller/">Third-party controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gc/">Reclaim IP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../route/">Route support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../coordinator/">Plugin coordinator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ifacer/">Plugin ifacer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../network-topology/">node-based topology</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../debug/">FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Concepts</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/arch/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/allocation/">IP Allocation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/metrics/">Metrics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/multusconfig/">Multus</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/gc/">Recycle IP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/solution/">Underlay and overlay solutions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../concepts/performance/">IPAM Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/annotation/">Annotations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/configmap/">Configmap</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/spiderpool-controller/">spiderpool-controller</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/spiderpool-agent/">spiderpool-agent</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spidersubnet/">CRD SpiderSubnet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spiderippool/">CRD SpiderIPPool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spidermultusconfig/">CRD Spidermultusconfig</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spidercoordinator/">CRD Spidercoordinator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spiderendpoint/">CRD SpiderEndpoint</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/crd-spiderreservedip/">CRD SpiderReservedIP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/plugin-coordinator/">Coordinatorr plugin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/plugin-ifacer/">Ifacer plugin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../reference/plugin-ipam/">IPAM plugin</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../develop/contributing/">Contribution Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../develop/CODE-OF-CONDUCT/">Code of Conduct</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../develop/release/">Release workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../develop/roadmap/">Roadmap</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../develop/swagger_openapi/">Swagger OpenAPI</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">spiderpool</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Installation &raquo;</li>
          <li>Overlay installation &raquo;</li>
      <li class="breadcrumb-item active">Calico</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/spidernet-io/spiderpool/edit/master/docs/usage/install/overlay/get-started-calico.md">Edit on spidernet-io/spiderpool</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="calico-quick-start">Calico Quick Start</h1>
<p><strong>English</strong> | <a href="../get-started-calico-zh_cn/"><strong>简体中文</strong></a></p>
<p>This page showcases the utilization of <code>Spiderpool</code>, a comprehensive Underlay network solution, in a cluster where <a href="https://github.com/projectcalico/calico">Calico</a> serves as the default CNI. <code>Spiderpool</code> leverages Multus to attach an additional NIC created with <code>Macvlan</code> to Pods and coordinates routes among multiple NICs using <code>coordinator</code>. This setup enables Pod's east-west traffic to be forwarded through the Calico-created NIC (eth0). The advantages offered by Spiderpool's solution are:</p>
<ul>
<li>Solve Macvlan's problem for accessing ClusterIP when Pods have both Calico and Macvlan NICs attached.</li>
<li>Facilitate the forwarding of external access to NodePort through Calico's data path, eliminating the need for external routing. Whereas, external routing is typically required for forwarding when Macvlan is used as the CNI.</li>
<li>Coordinate subnet routing for Pods with multiple Calico and Macvlan NICs, guaranteeing consistent traffic forwarding path for Pods and uninterrupted network connectivity.</li>
</ul>
<blockquote>
<p><code>NAD</code> is an abbreviation for Multus **N**etwork-**A**ttachment-**D**efinition CR.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>A ready Kubernetes cluster.</li>
<li>Calico has been already installed as the default CNI for your cluster. If it is not installed, please refer to <a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/">the official documentation</a> or follow the commands below for installation:</li>
</ul>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/projectcalico/calico/blob/master/manifests/calico.yaml
~#<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>calico-node<span class="w">  </span>pod<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>
</code></pre></div>
<ul>
<li>If the <a href="https://www.cni.dev/plugins/current/">cni plugins</a> are not installed under <code>/opt/cni/bin</code> on each node of your cluster, follow the commands below for installation:</li>
</ul>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>wget<span class="w"> </span>https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz
~#<span class="w"> </span>tar<span class="w"> </span>xvfzp<span class="w"> </span>./cni-plugins-linux-amd64-v1.3.0.tgz<span class="w"> </span>-C<span class="w"> </span>/opt/cni/bin
</code></pre></div>
<ul>
<li>Helm binary</li>
</ul>
<h2 id="install-spiderpool">Install Spiderpool</h2>
<p>Follow the command below to install Spiderpool:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>spiderpool<span class="w"> </span>https://spidernet-io.github.io/spiderpool
~#<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>update<span class="w"> </span>spiderpool
~#<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span>spiderpool<span class="w"> </span>spiderpool/spiderpool<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w">  </span>--set<span class="w"> </span>coordinator.mode<span class="o">=</span>overlay<span class="w"> </span>--wait<span class="w"> </span>
</code></pre></div>
<blockquote>
<p>By default, Spiderpool automatically installs Multus. However, if Multus has been already installed, you can skip the installation via the following command: <code>helm install spiderpool spiderpool/spiderpool --namespace kube-system --set multus.install=false</code> 
It is necessary to specify that the coordinator operates in overlay mode</p>
</blockquote>
<p>Check the status of Spiderpool after the installation is complete:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>spiderpool
spiderpool-agent-htcnc<span class="w">                                      </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">                 </span>1m
spiderpool-agent-pjqr9<span class="w">                                      </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">                 </span>1m
spiderpool-controller-7b7f8dd9cc-xdj95<span class="w">                      </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">                 </span>1m
spiderpool-init<span class="w">                                             </span><span class="m">0</span>/1<span class="w">     </span>Completed<span class="w">   </span><span class="m">0</span><span class="w">                 </span>1m
spiderpool-multus-m2kbt<span class="w">                                     </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">                 </span>1m
spiderpool-multus-sl65s<span class="w">                                     </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">                 </span>1m
</code></pre></div>
<h3 id="create-spiderippool">Create SpiderIPPool</h3>
<p>The subnet for the interface <code>ens192</code> on the cluster nodes here is <code>10.6.0.0/16</code>. Create a SpiderIPPool using this subnet:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="s">apiVersion: spiderpool.spidernet.io/v2beta1</span>
<span class="s">kind: SpiderIPPool</span>
<span class="s">metadata:</span>
<span class="s">  name: 10-6-v4</span>
<span class="s">spec:</span>
<span class="s">  disable: false</span>
<span class="s">  gateway: 10.6.0.1</span>
<span class="s">  ipVersion: 4</span>
<span class="s">  ips:</span>
<span class="s">  - 10.6.212.100-10.6.212.200</span>
<span class="s">  subnet: 10.6.0.0/16</span>
<span class="s">EOF</span>
</code></pre></div>
<blockquote>
<p>The subnet should be consistent with the subnet of <code>ens192</code> on the nodes, and ensure that the IP addresses do not conflict with any existing ones.</p>
</blockquote>
<h3 id="create-spidermultusconfig">Create SpiderMultusConfig</h3>
<p>The Multus NAD instance is created using Spidermultusconfig:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="s">apiVersion: spiderpool.spidernet.io/v2beta1</span>
<span class="s">kind: SpiderMultusConfig</span>
<span class="s">metadata:</span>
<span class="s">  name: macvlan-ens192</span>
<span class="s">spec:</span>
<span class="s">  cniType: macvlan</span>
<span class="s">  macvlan:</span>
<span class="s">    master:</span>
<span class="s">    - ens192</span>
<span class="s">    ippools:</span>
<span class="s">      ipv4:</span>
<span class="s">      - 10-6-v4</span>
<span class="s">    vlanID: 0</span>
<span class="s">EOF</span>
</code></pre></div>
<blockquote>
<p>Set <code>spec.macvlan.master</code> to <code>ens192</code> which must be present on the host. The subnet specified in <code>spec.macvlan.spiderpoolConfigPools.IPv4IPPool</code> should match that of <code>ens192</code>。</p>
</blockquote>
<p>Check if the Multus NAD has been created successfully:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>kubectl<span class="w">  </span>get<span class="w"> </span>network-attachment-definitions.k8s.cni.cncf.io<span class="w">  </span>macvlan-ens192<span class="w"> </span>-o<span class="w"> </span>yaml
apiVersion:<span class="w"> </span>k8s.cni.cncf.io/v1
kind:<span class="w"> </span>NetworkAttachmentDefinition
metadata:
<span class="w">  </span>annotations:
<span class="w">    </span>kubectl.kubernetes.io/last-applied-configuration:<span class="w"> </span><span class="p">|</span>
<span class="w">      </span><span class="o">{</span><span class="s2">&quot;apiVersion&quot;</span>:<span class="s2">&quot;spiderpool.spidernet.io/v2beta1&quot;</span>,<span class="s2">&quot;kind&quot;</span>:<span class="s2">&quot;SpiderMultusConfig&quot;</span>,<span class="s2">&quot;metadata&quot;</span>:<span class="o">{</span><span class="s2">&quot;annotations&quot;</span>:<span class="o">{}</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;macvlan-ens192&quot;</span>,<span class="s2">&quot;namespace&quot;</span>:<span class="s2">&quot;default&quot;</span><span class="o">}</span>,<span class="s2">&quot;spec&quot;</span>:<span class="o">{</span><span class="s2">&quot;cniType&quot;</span>:<span class="s2">&quot;macvlan&quot;</span>,<span class="s2">&quot;coordinator&quot;</span>:<span class="o">{</span><span class="s2">&quot;podCIDRType&quot;</span>:<span class="s2">&quot;cluster&quot;</span>,<span class="s2">&quot;tuneMode&quot;</span>:<span class="s2">&quot;overlay&quot;</span><span class="o">}</span>,<span class="s2">&quot;enableCoordinator&quot;</span>:true,<span class="s2">&quot;macvlan&quot;</span>:<span class="o">{</span><span class="s2">&quot;master&quot;</span>:<span class="o">[</span><span class="s2">&quot;ens192&quot;</span><span class="o">]</span>,<span class="s2">&quot;spiderpoolConfigPools&quot;</span>:<span class="o">{</span><span class="s2">&quot;IPv4IPPool&quot;</span>:<span class="o">[</span><span class="s2">&quot;10-6-v4&quot;</span><span class="o">]}</span>,<span class="s2">&quot;vlanID&quot;</span>:0<span class="o">}}}</span>
<span class="w">  </span>creationTimestamp:<span class="w"> </span><span class="s2">&quot;2023-06-30T07:12:21Z&quot;</span>
<span class="w">  </span>generation:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>name:<span class="w"> </span>macvlan-ens192
<span class="w">  </span>namespace:<span class="w"> </span>default
<span class="w">  </span>ownerReferences:
<span class="w">  </span>-<span class="w"> </span>apiVersion:<span class="w"> </span>spiderpool.spidernet.io/v2beta1
<span class="w">    </span>blockOwnerDeletion:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>controller:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>kind:<span class="w"> </span>SpiderMultusConfig
<span class="w">    </span>name:<span class="w"> </span>macvlan-ens192
<span class="w">    </span>uid:<span class="w"> </span>3f902f46-d9d4-4c62-a7c3-98d4a9aa26e4
<span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;24713635&quot;</span>
<span class="w">  </span>uid:<span class="w"> </span>712d1e58-ab57-49a7-9189-0fffc64aa9c3
spec:
<span class="w">  </span>config:<span class="w"> </span><span class="s1">&#39;{&quot;cniVersion&quot;:&quot;0.3.1&quot;,&quot;name&quot;:&quot;macvlan-ens192&quot;,&quot;plugins&quot;:[{&quot;type&quot;:&quot;macvlan&quot;,&quot;ipam&quot;:{&quot;type&quot;:&quot;spiderpool&quot;,&quot;default_ipv4_ippool&quot;:[&quot;10-6-v4&quot;]},&quot;master&quot;:&quot;ens192&quot;,&quot;mode&quot;:&quot;bridge&quot;},{&quot;type&quot;:&quot;coordinattor&quot;,&quot;ipam&quot;:{},&quot;dns&quot;:{},&quot;detectGateway&quot;:false,&quot;tunePodRoutes&quot;:true,&quot;mode&quot;:&quot;overlay&quot;,&quot;hostRuleTable&quot;:500,&quot;detectIPConflict&quot;:false}]}&#39;</span>
</code></pre></div>
<h3 id="create-an-application">Create an application</h3>
<p>Run the following command to create the demo application nginx:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl create -f -</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: nginx</span>
<span class="s">spec:</span>
<span class="s">  replicas: 2</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: nginx</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      annotations:</span>
<span class="s">        k8s.v1.cni.cncf.io/networks: macvlan-ens192</span>
<span class="s">      labels:</span>
<span class="s">        app: nginx</span>
<span class="s">    spec:</span>
<span class="s">      containers:</span>
<span class="s">      - name: nginx</span>
<span class="s">        image: nginx</span>
<span class="s">        imagePullPolicy: IfNotPresent</span>
<span class="s">        ports:</span>
<span class="s">        - name: http</span>
<span class="s">          containerPort: 80</span>
<span class="s">          protocol: TCP</span>
<span class="s">EOF</span>
</code></pre></div>
<ul>
<li><code>k8s.v1.cni.cncf.io/networks</code>: specifies that Multus uses <code>macvlan-ens192</code> to attach an additional interface to the Pod.</li>
</ul>
<p>Check the Pod's IP allocation after it is ready:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w">  </span>kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx<span class="w"> </span>-o<span class="w"> </span>wide
NAME<span class="w">                     </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">   </span>IP<span class="w">                </span>NODE<span class="w">        </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
nginx-4653bc4f24-aswpm<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>2m<span class="w">    </span><span class="m">10</span>.233.105.167<span class="w">    </span>controller<span class="w">  </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
nginx-4653bc4f24-rswak<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>2m<span class="w">    </span><span class="m">10</span>.233.73.210<span class="w">     </span>worker01<span class="w">    </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>se
NAME<span class="w">                     </span>INTERFACE<span class="w">   </span>IPV4POOL<span class="w">            </span>IPV4<span class="w">               </span>IPV6POOL<span class="w">   </span>IPV6<span class="w">   </span>NODE
nginx-4653bc4f24-rswak<span class="w">   </span>net1<span class="w">        </span><span class="m">10</span>-6-v4<span class="w">             </span><span class="m">10</span>.6.212.145/16<span class="w">                      </span>worker01
nginx-4653bc4f24-aswpm<span class="w">   </span>net1<span class="w">        </span><span class="m">10</span>-6-v4<span class="w">             </span><span class="m">10</span>.6.212.148/16<span class="w">                      </span>controller
</code></pre></div>
<p>Enter the Pod and use the command <code>ip</code> to view information such as IP addresses and routes within the Pod:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@controller1<span class="w"> </span>~<span class="o">]</span><span class="c1"># kubectl exec it nginx-4653bc4f24-rswak sh</span>
<span class="c1"># ip a</span>
<span class="m">1</span>:<span class="w"> </span>lo:<span class="w"> </span>&lt;LOOPBACK,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">65536</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/loopback<span class="w"> </span><span class="m">00</span>:00:00:00:00:00<span class="w"> </span>brd<span class="w"> </span><span class="m">00</span>:00:00:00:00:00
<span class="w">    </span>inet<span class="w"> </span><span class="m">127</span>.0.0.1/8<span class="w"> </span>scope<span class="w"> </span>host<span class="w"> </span>lo
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>::1/128<span class="w"> </span>scope<span class="w"> </span>host
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="m">2</span>:<span class="w"> </span>tunl0@NONE:<span class="w"> </span>&lt;NOARP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1480</span><span class="w"> </span>qdisc<span class="w"> </span>noop<span class="w"> </span>state<span class="w"> </span>DOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ipip<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>brd<span class="w"> </span><span class="m">0</span>.0.0.0
<span class="m">4</span>:<span class="w"> </span>eth0@if3:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1430</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
<span class="w">    </span>link/ether<span class="w"> </span>a2:99:9d:04:01:80<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netnsid<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.233.73.210/32<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>eth0
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fd85:ee78:d8a6:8607::1:eb84/128<span class="w"> </span>scope<span class="w"> </span>global
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fe80::a099:9dff:fe04:180/64<span class="w"> </span>scope<span class="w"> </span>link
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="m">5</span>:<span class="w"> </span>net1@if2:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
<span class="w">    </span>link/ether<span class="w"> </span>2a:1e:a1:db:2a:9a<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netnsid<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.6.212.145/16<span class="w"> </span>brd<span class="w"> </span><span class="m">10</span>.6.255.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>net1
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fd00:10:6::2e5/64<span class="w"> </span>scope<span class="w"> </span>global
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fe80::281e:a1ff:fedb:2a9a/64<span class="w"> </span>scope<span class="w"> </span>link
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
/#<span class="w"> </span>ip<span class="w"> </span>rule
<span class="m">0</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span><span class="nb">local</span>
<span class="m">32760</span>:<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.233.73.210<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32762</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32763</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.233.64.0/18<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32764</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.233.0.0/18<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32765</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.6.212.132<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32766</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>main
<span class="m">32767</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>default
/#<span class="w"> </span>ip<span class="w"> </span>route
default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.0.1<span class="w"> </span>dev<span class="w"> </span>net1
<span class="m">10</span>.6.0.0/16<span class="w"> </span>dev<span class="w"> </span>net1<span class="w"> </span>scope<span class="w"> </span>link<span class="w">  </span>src<span class="w"> </span><span class="m">10</span>.6.212.145
/<span class="w"> </span><span class="c1"># ip route show table 100</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">10</span>.6.212.132<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link
<span class="m">10</span>.233.0.0/18<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.212.132<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>
<span class="m">10</span>.233.64.0/18<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.212.132<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<p>Explanation of the above:</p>
<blockquote>
<p>The Pod is allocated two interfaces: eth0 (Calico) and net1 (Macvlan), having IPv4 addresses of 10.233.73.210 and 10.6.212.145, respectively.
10.233.0.0/18 and 10.233.64.0/18 represent the cluster's CIDR. When the Pod accesses this subnet, traffic will be forwarded through eth0. Each route table will include this route.
10.6.212.132 is the IP address of the node where the Pod has been scheduled. This route ensures that when the Pod accesses the host, it will be forwarded through eth0.
This series of routing rules guarantees that the Pod will forward traffic through eth0 when accessing targets within the cluster and through net1 for external targets.
By default, the Pod's default route is reserved in net1. To reserve it in eth0, add the following annotation to the Pod's metadata: "ipam.spidernet.io/default-route-nic: eth0".</p>
</blockquote>
<p>To test the basic network connectivity of the Pod, we will use the example of accessing the CoreDNS Pod and Service:</p>
<div class="highlight"><pre><span></span><code>~#<span class="w"> </span>kubectl<span class="w">  </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>kube-dns<span class="w"> </span>-o<span class="w"> </span>wide
NAME<span class="w">                           </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">      </span>AGE<span class="w">   </span>IP<span class="w">               </span>NODE<span class="w">          </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
pod/coredns-57fbf68cf6-2z65h<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>91d<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>91d<span class="w">   </span><span class="m">10</span>.233.105.131<span class="w">   </span>worker1<span class="w">       </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
pod/coredns-57fbf68cf6-kvcwl<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>91d<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>91d<span class="w">   </span><span class="m">10</span>.233.73.195<span class="w">    </span>controller<span class="w">    </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;

NAME<span class="w">              </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">   </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">                  </span>AGE<span class="w">   </span>SELECTOR
service/coredns<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.233.0.3<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">53</span>/UDP,53/TCP,9153/TCP<span class="w">   </span>91d<span class="w">   </span>k8s-app<span class="o">=</span>kube-dns

~#<span class="w"> </span>Access<span class="w"> </span>the<span class="w"> </span>CoreDNS<span class="w"> </span>Pod<span class="w"> </span>across<span class="w"> </span>nodes
~#<span class="w"> </span>kubectl<span class="w">  </span><span class="nb">exec</span><span class="w"> </span>nginx-4653bc4f24-rswak<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.233.73.195<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span>
PING<span class="w"> </span><span class="m">10</span>.233.73.195<span class="w"> </span><span class="o">(</span><span class="m">10</span>.233.73.195<span class="o">)</span>:<span class="w"> </span><span class="m">56</span><span class="w"> </span>data<span class="w"> </span>bytes
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.233.73.195:<span class="w"> </span><span class="nv">seq</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">62</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">2</span>.348<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.233.73.195:<span class="w"> </span><span class="nv">seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">62</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.586<span class="w"> </span>ms

---<span class="w"> </span><span class="m">10</span>.233.73.195<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<span class="m">2</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">2</span><span class="w"> </span>packets<span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss
round-trip<span class="w"> </span>min/avg/max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.586/1.467/2.348<span class="w"> </span>ms

~#<span class="w"> </span>Access<span class="w"> </span>the<span class="w"> </span>CoreDNS<span class="w"> </span>Service
~#<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w">  </span>nginx-4653bc4f24-rswak<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span><span class="m">10</span>.233.0.3:53<span class="w"> </span>-I
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w"> </span>--:--:--<span class="w">  </span><span class="m">0</span>:00:02<span class="w"> </span>--:--:--<span class="w">     </span><span class="m">0</span>
curl:<span class="w"> </span><span class="o">(</span><span class="m">52</span><span class="o">)</span><span class="w"> </span>Empty<span class="w"> </span>reply<span class="w"> </span>from<span class="w"> </span>server
</code></pre></div>
<p>Test the Pod's connectivity for north-south traffic, specifically accessing targets in another subnet (10.7.212.101):</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@controller1<span class="w"> </span>cyclinder<span class="o">]</span><span class="c1"># kubectl exec nginx-4653bc4f24-rswak -- ping 10.7.212.101 -c 2</span>
PING<span class="w"> </span><span class="m">10</span>.7.212.101<span class="w"> </span><span class="o">(</span><span class="m">10</span>.7.212.101<span class="o">)</span>:<span class="w"> </span><span class="m">56</span><span class="w"> </span>data<span class="w"> </span>bytes
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.7.212.101:<span class="w"> </span><span class="nv">seq</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">61</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">4</span>.349<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.7.212.101:<span class="w"> </span><span class="nv">seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">61</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.877<span class="w"> </span>ms

---<span class="w"> </span><span class="m">10</span>.7.212.101<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<span class="m">2</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">2</span><span class="w"> </span>packets<span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss
round-trip<span class="w"> </span>min/avg/max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.877/2.613/4.349<span class="w"> </span>ms
</code></pre></div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../underlay/get-started-sriov/" class="btn btn-neutral float-left" title="SRIOV"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../get-started-cilium/" class="btn btn-neutral float-right" title="Cilium">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../underlay/get-started-sriov/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../get-started-cilium/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
      <script src="../../../../js/version-select.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

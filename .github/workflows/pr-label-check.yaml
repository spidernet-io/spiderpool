# make sure the pr is labeled as wanted, case: we could generate changelog by the pr label
name: PR Label Check

# Trigger the workflow on pull requests only
on:
  pull_request:
    types: [opened, labeled, unlabeled, synchronize]

permissions:
  pull-requests: write
  issues: write

env:
  LEASE_ONE_OF_LABELS: "release/bug release/feature-new release/feature-changed release/none pr/robot_update"
  FORBID_LABELS: "pr/not-ready not-ready"

jobs:
  post-label-reminder:
    name: Post Label Reminder
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Post reminder comment
        uses: actions/github-script@v7
        with:
          script: |
            const labels = {
              'release/bug': 'üêõ Bug fix - fixes an existing bug',
              'release/feature-new': '‚ú® New feature - adds new functionality',
              'release/feature-changed': 'üîÑ Feature change - modifies existing functionality',
              'release/none': 'üìù No release note - documentation, tests, or internal changes',
              'pr/robot_update': 'ü§ñ Robot update - automated dependency or version updates'
            };

            let message = `## üìã Release Label Required\n\n`;
            message += `To automatically generate release notes, this PR must have at least one of the following labels:\n\n`;

            for (const [label, description] of Object.entries(labels)) {
              message += `- \`${label}\`: ${description}\n`;
            }

            message += `Use the following commands in a comment:\n`;
            message += `- \`/label release/bug\`\n`;
            message += `- \`/label release/feature-new\`\n`;
            message += `- \`/label release/feature-changed\`\n`;
            message += `- \`/label release/none\`\n`;
            message += `- \`/label pr/robot_update\`\n\n`;

            message += `---\n`;
            message += `*This message is automatically sent by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

  check-label:
    name: Check label set
    runs-on: ubuntu-latest
    if: github.event.action != 'opened'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # must set one of required label, for release note generator
      - name: check label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          PR_NUMBER="${{ github.event.number }}"
          [ -n "${PR_NUMBER}" ] || { echo "Error: no PR number found" ; exit 1 ; }
          gh pr view ${PR_NUMBER}
          PR_LABEL=` gh pr view ${PR_NUMBER} | grep -i "^labels:" | tr ',' ' ' | tr -s ' ' | sed 's/labels://g' `
          [ -n "${PR_LABEL}" ] || { echo "Error: no labels found on PR" ;  exit 1 ; }
          echo "============ checking forbidden label ============ "
          for LABEL in ${PR_LABEL} ; do
              if grep -i " ${LABEL} " <<< " ${{ env.FORBID_LABELS }} " &>/dev/null ; then
                  echo "Error: forbidden label ${LABEL} must be removed. All forbidden labels: '${{ env.FORBID_LABELS }}' "
                  exit 1
              fi
          done
          echo "============ checking required label ============ "
          COUNTER=0
          for LABEL in ${PR_LABEL} ; do
              ! grep -i " ${LABEL} " <<< " ${{ env.LEASE_ONE_OF_LABELS }} " &>/dev/null  || (( COUNTER=COUNTER+1 ))
          done
          if (( COUNTER == 0 )) ; then
              echo "‚ùå Error: At least one of the following labels is required: '${{ env.LEASE_ONE_OF_LABELS }}'"
              echo ""
              echo "üìã Label descriptions:"
              echo "  - release/bug: Bug fix"
              echo "  - release/feature-new: New feature"
              echo "  - release/feature-changed: Feature change or breaking change"
              echo "  - release/none: No release note needed (docs, tests, etc.)"
              echo "  - pr/robot_update: Automated updates"
              echo ""
              echo "üè∑Ô∏è How to add labels:"
              echo "  1. Manually add label from the right sidebar"
              echo "  2. Use keywords in PR title/description: [bug], [feature], [changed], [docs], [robot]"
              echo "  3. Comment with: /label release/bug (or other label names)"
              echo ""
              echo "See the auto-comment on this PR for more details."
              exit 1
          fi
          echo "============ result ============ "
          echo "PR labels: ${PR_LABEL}"
          echo "Required labels (at least one): ${{ env.LEASE_ONE_OF_LABELS }} "
          echo "Forbidden labels: ${{ env.FORBID_LABELS }} "

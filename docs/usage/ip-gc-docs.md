# 云原生 Spiderpool: 优异的 GC 机制

## 为什么使用 Underlay 网络

低延迟和高吞吐量需求：在一些需要低延迟和高吞吐量的应用场景中，Underlay 网络方案通常比 Overlay 网络方案更具优势。由于 Underlay 网络是基于物理网络构建的，因此可以提供更快速和稳定的网络传输服务。

传统主机应用上云：在数据中心内，许多传统主机应用仍然使用传统的网络对接方式，例如服务暴露和发现、多子网对接等。在这种情况下，使用 Underlay 网络解决方案可以更好地满足这些应用的需求。

数据中心网络管理需求：数据中心管理人员通常需要对应用实施安全管控，例如使用防火墙、vlan隔离等手段。此外，他们还需要使用传统的网络观测手段实施集群网络监控。使用underlay网络解决方案可以更方便地实现这些需求。

独立的宿主机网卡规划：在一些特殊的应用场景下，例如kubevirt、存储项目、日志项目等，需要实施独立的宿主机网卡规划，以保证底层子网的带宽隔离。使用underlay网络解决方案可以更好地支持这些应用的需求，从而提高应用的性能和可靠性。

Underlay 网络是底层基础网络，具有低延迟、可靠、安全等特性。这些特性能满足一些延时敏感的应用业务需求、提供优质的用户体验以及有效管理和保护网络资源，通常应用在延时敏感、防火墙安全管控中。

- 延时敏感的应用：某些特定行业或应用（如金融交易、实时视频传输等）对网络延迟非常敏感。在这种情况下，Underlay 网络可以提供更低的延迟，通过直接控制物理和链路层的连接来减少数据传输的时间。这种低延迟的特性使得 Underlay 网络成为满足这些应用需求的理想选择。

- 防火墙安全管控：在集群中，防火墙通常用于管理南北向通信，即集群内部和外部网络之间的通信。为了实现安全管控，防火墙需要对通信流量进行检查和过滤，并对出口通信进行限制。在这种情况下，通过 Underlay 网络的 IPAM 对应用固定出口 IP 地址，可以更好地管理和控制集群与外部网络之间的通信，提高网络的安全性。

随着数据中心私有云的不断普及，Underlay 网络作为数据中心网络架构的重要组成部分，已经被广泛应用于数据中心的网络架构中，以提供更高效的网络传输和更好的网络拓扑管理能力。

## GC 需求

在我们使用 underlay 网络的时候，每个容器实例都需要一个唯一的 IP，同时由于 underlay 网络下 IP 地址有限。如果 IP 地址不能正确回收，将会导致出现 IP 资源的的浪费。
同时在大规模集群下，如果
在容器编排和管理的环境中，每个容器实例都需要分配一个唯一的IP地址用于网络通信。而在大规模的容器集群中，容器实例的数量可能会非常庞大，因此需要大量的 IP 地址资源来支持容器的运行。然而，由于在 Underlay 网络下 IP 地址资源稀缺，因此必须采取有效的措施来最大程度地利用这些资源。

在这种情况下，IPAM 组件的作用就显得尤为重要。IPAM 组件是负责管理 IP 地址分配和回收的组件，它可以在需要的时候为容器实例分配 IP 地址，并在容器实例不再需要时回收这些 IP 地址，以便重新利用。

如果 IPAM 组件没有及时回收未使用的IP地址，那么新启动的 Pod 可能会因为缺少可用的IP地址而无法成功启动。这将导致容器集群的稳定性和可靠性受到威胁，甚至可能导致整个应用程序无法正常运行。因此，IPAM组件必须具备更加精准、高效、及时的IP回收机制，及时回收未使用的IP地址，以确保容器实例有足够的可用IP地址来支持其正常运行。

总之，IP地址资源的稀缺性和应用对IP地址的固定需求，都要求IPAM组件具有高效、及时、精准的IP地址回收机制，以确保容器集群的稳定性和可靠性。

## Spiderpool GC 功能

[Spiderpool](https://github.com/spidernet-io/spiderpool) 是一个 Kubernetes 的 IPAM 插件项目，其主要针对于 Underlay 网络的 IP 地址管理需求而设计，能够为任何兼容第三方 IPAM 插件的 CNI 项目所使用。而基于跨越网络区域的 IP 分配是 Spiderpool 的一个重要功能支持，同时它还包括应用 IP 地址固定、IP 地址自动弹性扩缩容、多网卡、双栈支持等特点。更多说明参考 [Spiderpool 功能](https://github.com/spidernet-io/spiderpool/blob/main/README-zh_CN.md) 介绍。

## gc 的高效性能

在测试场景中基于 0.3.1 版本的 CNI Specification，以 macvlan 搭配 Spiderpool 作为测试方案，并选择了开源社区中其它几种对接 underlay 网络的方案作为对比：

不同 cni 特点对比：

* Spiderpool

    集群中存在多个 IP 池，每个池中的 IP 地址都可以被集群中的任意一个节点上的 Pod 所使用，当集群中的多个 Pod 并发的从同一个池中分配 IP 地址时，存在
竞争。支持托管 IP 池的全生命流程，使其同步的与工作负载创建、扩缩容、删除，弱化了过大的共享池所带来的并发或存储问题。

* whereabouts
    各节点可以定义各自可用的 IP 池范围，若节点间存在重复定义的 IP 地址，那么这些 IP 地址上升为一种共享资源。

* Kube-OVN
以子网来组织 IP 地址，每个 Namespace 可以归属于特定的子网， Namespace 下的 Pod 会自动从所属的子网中获取 IP 地址。子网也是一种集群资源，同一个子网的 IP 地址可以分布在任意一个节点上。

* 
每个节点独享一个或多个 IP block，各节点上的 Pod 仅使用本地 IP block 中的 IP 地址，节点间无任何竞争与冲突，分配的效率非常高。
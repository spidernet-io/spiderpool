
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-8.5.10">
    
    
      
        <title>Calico/Macvlan Multi-CNI Data Forwarding Workflow - spiderpool</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#calico-macvlan-multi-cni-data-forwarding-process" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../..">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="spiderpool" class="md-header__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spiderpool
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Calico/Macvlan Multi-CNI Data Forwarding Workflow
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="spiderpool" class="md-nav__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    spiderpool
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/get-started-kind/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usage/readme/" class="md-nav__link">
        Index
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Underlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Underlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Underlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-weave/" class="md-nav__link">
        Weave
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-macvlan/" class="md-nav__link">
        Macvlan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-ovs/" class="md-nav__link">
        Ovs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-sriov/" class="md-nav__link">
        SR-IOV
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Overlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Overlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Overlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/overlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/overlay/get-started-cilium/" class="md-nav__link">
        Cilium
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Public Cloud Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Public Cloud Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Public Cloud Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-alibaba/" class="md-nav__link">
        Alibaba Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-aws/" class="md-nav__link">
        AWS Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-vmware/" class="md-nav__link">
        VWware vSphere
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-openstack/" class="md-nav__link">
        OpenStack
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          AI Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AI Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          AI Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/ai/get-started-sriov/" class="md-nav__link">
        AI Cluster with Sriov
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/ai/get-started-macvlan/" class="md-nav__link">
        AI Cluster with Macvlan
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/upgrade/" class="md-nav__link">
        Upgrading
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/uninstall/" class="md-nav__link">
        Uninstalling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/system-requirements/" class="md-nav__link">
        System requirements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ipam-des/" class="md-nav__link">
        IPAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ipam-performance/" class="md-nav__link">
        IPAM Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../coordinator/" class="md-nav__link">
        Plugin coordinator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io-performance/" class="md-nav__link">
        I/O Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blog/" class="md-nav__link">
        Blogs
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Calico/Macvlan Multi-CNI Data Forwarding Workflow
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Calico/Macvlan Multi-CNI Data Forwarding Workflow
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    Quick start
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serval-data-forwarding-flow" class="md-nav__link">
    Serval Data forwarding Flow
  </a>
  
    <nav class="md-nav" aria-label="Serval Data forwarding Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-forwarding-process-between-macvlan-pods" class="md-nav__link">
    Data Forwarding Process Between Macvlan Pods
  </a>
  
    <nav class="md-nav" aria-label="Data Forwarding Process Between Macvlan Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-pods-in-the-same-subnet" class="md-nav__link">
    Macvlan Access to Pods in the Same Subnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-pods-in-different-subnets" class="md-nav__link">
    Macvlan Access to Pods in Different Subnets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-access-to-local-node" class="md-nav__link">
    Macvlan Pod Access to Local Node
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-access-to-macvlan-pods-service" class="md-nav__link">
    Macvlan Pod Access to Macvlan Pod's Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-calico-pod" class="md-nav__link">
    Macvlan Access to Calico Pod
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-accessing-calico-pods-service" class="md-nav__link">
    Macvlan Pod Accessing Calico Pod's Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calicomacvlan-multi-nic-pod-accessing-calico-and-macvlan-pods" class="md-nav__link">
    Calico+Macvlan Multi-NIC Pod Accessing Calico and Macvlan Pods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calicomacvlan-multi-nic-pod-accessing-service" class="md-nav__link">
    Calico+Macvlan Multi-NIC Pod Accessing Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-nodeport-of-calico-macvlan-multi-nic-pod-as-shown-by-the-black-arrow-in-figure-5" class="md-nav__link">
    Accessing NodePort of Calico-Macvlan Multi-NIC Pod (as shown by the black arrow in Figure 5)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-multus-config/" class="md-nav__link">
        SpiderMultusConfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-ippool/" class="md-nav__link">
        IPAM of SpiderIPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-affinity/" class="md-nav__link">
        IPAM of IPPool Affinity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-subnet/" class="md-nav__link">
        IPAM of SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/operator/" class="md-nav__link">
        IPAM for operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/statefulset/" class="md-nav__link">
        IPAM for StatefulSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/reserved-ip/" class="md-nav__link">
        IPAM of Reserved IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/multi-interfaces-annotation/" class="md-nav__link">
        MultipleInterfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/egress/" class="md-nav__link">
        Egress Policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/cilium-chaining/" class="md-nav__link">
        Network Policy Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/route/" class="md-nav__link">
        Route Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/network-topology/" class="md-nav__link">
        Node-based Topology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/ipoib/" class="md-nav__link">
        IPoIB For Infiniband
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/submariner/" class="md-nav__link">
        Multi-Cluster Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/underlay_cni_service/" class="md-nav__link">
        Access Service for Underlay CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/ipvlan_bandwidth/" class="md-nav__link">
        Bandwidth Manage for IPVlan CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/kubevirt/" class="md-nav__link">
        Kubevirt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/istio/" class="md-nav__link">
        Istio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/rdma-metrics/" class="md-nav__link">
        Enable RDMA metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/annotation/" class="md-nav__link">
        Annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/configmap/" class="md-nav__link">
        Configmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-controller/" class="md-nav__link">
        spiderpool-controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-agent/" class="md-nav__link">
        spiderpool-agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidersubnet/" class="md-nav__link">
        CRD SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderippool/" class="md-nav__link">
        CRD SpiderIPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidermultusconfig/" class="md-nav__link">
        CRD Spidermultusconfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidercoordinator/" class="md-nav__link">
        CRD Spidercoordinator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderendpoint/" class="md-nav__link">
        CRD SpiderEndpoint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderreservedip/" class="md-nav__link">
        CRD SpiderReservedIP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ifacer/" class="md-nav__link">
        Ifacer plugin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ipam/" class="md-nav__link">
        IPAM plugin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/contributing/" class="md-nav__link">
        Contribution Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/CODE-OF-CONDUCT/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/release/" class="md-nav__link">
        Release workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/swagger_openapi/" class="md-nav__link">
        Swagger OpenAPI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    Quick start
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serval-data-forwarding-flow" class="md-nav__link">
    Serval Data forwarding Flow
  </a>
  
    <nav class="md-nav" aria-label="Serval Data forwarding Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-forwarding-process-between-macvlan-pods" class="md-nav__link">
    Data Forwarding Process Between Macvlan Pods
  </a>
  
    <nav class="md-nav" aria-label="Data Forwarding Process Between Macvlan Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-pods-in-the-same-subnet" class="md-nav__link">
    Macvlan Access to Pods in the Same Subnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-pods-in-different-subnets" class="md-nav__link">
    Macvlan Access to Pods in Different Subnets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-access-to-local-node" class="md-nav__link">
    Macvlan Pod Access to Local Node
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-access-to-macvlan-pods-service" class="md-nav__link">
    Macvlan Pod Access to Macvlan Pod's Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-access-to-calico-pod" class="md-nav__link">
    Macvlan Access to Calico Pod
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macvlan-pod-accessing-calico-pods-service" class="md-nav__link">
    Macvlan Pod Accessing Calico Pod's Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calicomacvlan-multi-nic-pod-accessing-calico-and-macvlan-pods" class="md-nav__link">
    Calico+Macvlan Multi-NIC Pod Accessing Calico and Macvlan Pods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calicomacvlan-multi-nic-pod-accessing-service" class="md-nav__link">
    Calico+Macvlan Multi-NIC Pod Accessing Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-nodeport-of-calico-macvlan-multi-nic-pod-as-shown-by-the-black-arrow-in-figure-5" class="md-nav__link">
    Accessing NodePort of Calico-Macvlan Multi-NIC Pod (as shown by the black arrow in Figure 5)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  <a href="https://github.com/spidernet-io/spiderpool/edit/master/docs/concepts/multi_cni_coexist.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="calico-macvlan-multi-cni-data-forwarding-process">Calico + Macvlan Multi-CNI Data Forwarding Process</h1>
<p><strong>English</strong> | <a href="../multi_cni_coexist-zh_CN/"><strong>简体中文</strong></a></p>
<h2 id="background">Background</h2>
<p>CNIs are important components of a Kubernetes cluster. Typically, one CNI (e.g. Calico) is deployed and is responsible for the connectivity of the cluster network. In some cases, customers may use multiple types of CNIs in the cluster based on performance, security, etc., such as Macvlan CNIs of the Underlay type, and then there may be multiple Pods of different CNI types in a cluster, and different types of Pods are suitable for different scenarios:</p>
<ul>
<li>Pod with a single Calico NIC: System components such as CoreDNS do not have the need for a fixed IP, nor do they need to communicate with north-south traffic, but only need to communicate with east-west traffic in the cluster.</li>
<li>Pods with a single Macvlan card: For applications with special requirements for performance and security, or for traditional up-cloud applications that require direct north-south traffic with the Pod IP.</li>
<li>Multi-Card Pod with Calico and Macvlan cards: A combination of both. Both need to access cluster north-south traffic with a fixed Pod IP and cluster east-west traffic (e.g., with a Calico Pod or Service).</li>
</ul>
<p>In addition, when multiple CNI pods exist in a cluster, there are actually two different data forwarding schemes in the cluster: Underlay and Overlay. this can lead to a number of other issues:</p>
<ul>
<li>Pods using the Underlay network cannot access the cluster's north-south traffic.</li>
<li>Pods using Underlay networks cannot communicate directly with Pods using Overlay networks in the cluster: Due to inconsistent forwarding paths, Overlay networks often need to go through nodes for secondary forwarding, whereas Underlay networks are generally forwarded directly through the underlying gateway. Therefore, when they access each other, packet loss may occur because the underlying switch does not synchronize the routes of the cluster subnet.</li>
<li>Using two network modes for a cluster may increase the complexity of use and operation, such as IP address management.</li>
</ul>
<p>Spiderpool is a complete Underlay network solution that solves the interoperability problem when there are multiple CNIs in a cluster and reduces the IP address operation and maintenance burden. The following section describes the data forwarding process between them.</p>
<h2 id="quick-start">Quick start</h2>
<ul>
<li>Calico + Macvlan multi-network card quickstart can be found in <a href="../../usage/install/overlay/get-started-calico/">get-stared-calico</a></li>
<li>For a single Macvlan card see <a href="../../usage/install/underlay/get-started-macvlan/">get-started-macvlan</a>.</li>
<li>Underlay CNI Access Service See <a href="../../usage/underlay_cni_service/">underlay_cni_service</a></li>
</ul>
<h2 id="serval-data-forwarding-flow">Serval Data forwarding Flow</h2>
<p>Below are several typical communication scenarios:</p>
<ul>
<li>
<p><a href="#data-forwarding-process-between-macvlan-pods">Macvlan Accessing Macvlan Pods</a></p>
</li>
<li>
<p><a href="#macvlan-pod-access-to-macvlan-pods-service">Macvlan Pod Access to Macvlan Pod's Service</a></p>
</li>
<li>
<p><a href="#macvlan-access-to-calico-pod">Macvlan Accessing Calico Pods</a></p>
</li>
<li>
<p><a href="#macvlan-pod-accessing-calico-pods-service">Macvlan Pod Accessing Calico Pod's Service</a></p>
</li>
<li><a href="#calicomacvlan-multi-nic-pod-accessing-calico-and-macvlan-pods">Calico+Macvlan Multi-NIC Pods Accessing Calico and Macvlan Pods</a></li>
<li><a href="#calicomacvlan-multi-nic-pod-accessing-service">Calico+Macvlan Multi-NIC Pods Accessing Service</a></li>
<li><a href="#accessing-nodeport-of-calico-macvlan-multi-nic-pod-as-shown-by-the-black-arrow-in-figure-5">Accessing NodePort of Calico-Macvlan Multi-NIC Pods</a></li>
</ul>
<h3 id="data-forwarding-process-between-macvlan-pods">Data Forwarding Process Between Macvlan Pods</h3>
<p><img alt="Macvlan Pod Communication Flow" src="../../images/macvlan-macvlan.png" /></p>
<h4 id="macvlan-access-to-pods-in-the-same-subnet">Macvlan Access to Pods in the Same Subnet</h4>
<p>As shown in <code>Figure 1</code> <code>Label 2</code>, Macvlan Pod1(172.16.1.3) directly accesses Macvlan Pod2(172.16.1.2) through the Macvlan Bridge mode mechanism. Whether on the same node or different nodes, gateway forwarding is not required.</p>
<h4 id="macvlan-access-to-pods-in-different-subnets">Macvlan Access to Pods in Different Subnets</h4>
<p>As shown in <code>Figure 1</code> <code>Label 1</code>, Macvlan Pod1(172.16.1.2) accesses cross-segment and cross-node Macvlan Pod2(172.16.2.100) or cross-segment but same-node Macvlan Pod3(172.17.1.100). Due to different network segments, gateway forwarding is required.</p>
<h4 id="macvlan-pod-access-to-local-node">Macvlan Pod Access to Local Node</h4>
<p>As shown in <code>Figure 1</code> <code>Label 3</code>: Due to the Macvlan bridge mechanism, Macvlan sub-interfaces cannot communicate directly with the Master interface. Therefore, we created a veth network card in the Macvlan Pod (e.g., 172.17.1.100) and set up routes in both Pod and node to solve the communication issue. The node(172.17.1.1) accesses Macvlan Pod(172.17.1.100) according to the route in node table500, forwarding from vethxxx to the Pod's network namespace.</p>
<div class="language-text highlight"><pre><span></span><code>    # pod network namespace
    ~# ip r 
    172.17.1.1 dev veth0 
    # host network namespace
    ~# ip r show table 500
    172.17.1.100 dev vethxxx
</code></pre></div>
<h3 id="macvlan-pod-access-to-macvlan-pods-service">Macvlan Pod Access to Macvlan Pod's Service</h3>
<p><img alt="Macvlan Pod Access to Macvlan Pod's Service" src="../../images/macvlan-macvlan-service.png" /></p>
<p><em>Accessing ClusterIP (as shown by the black line in <code>Figure 2</code>)</em>:</p>
<ul>
<li>
<p>Macvlan Pod(172.17.1.100) accessing ClusterIP(10.233.0.100) matches Pod internal routing and forwards packets through veth0 network card to the node</p>
<div class="language-text highlight"><pre><span></span><code># pod network namespace
~# ip r 
10.233.0.0/18 dev veth0
</code></pre></div>
</li>
<li>
<p>Through the Service DNAT rules set by node Kube-proxy, ClusterIP(10.233.0.100) is resolved to target Macvlan Pod(172.17.1.200), and packets are forwarded to 172.17.1.200 through inter-node network. At this point, the source address has been SNAT'd to node IP: 172.17.1.1.</p>
</li>
<li>Upon reaching Node2(172.17.1.2), packets are forwarded to target Pod(172.17.1.200) through vethxx via the host's table500 routing table.</li>
<li>When the target Pod(172.17.1.200) sends response packets, its destination address is Node1's address: 172.17.1.1, so response packets are sent from veth0 through the node network back to Node1. Through Node1's Kube-proxy iptables rules, the source address is restored to ClusterIP(10.233.0.100) and destination address to Macvlan Pod(172.17.1.100)</li>
<li>Through the host's table500 routing table, response packets are forwarded via vethxx network card to source Pod(172.17.1.100), completing the access process.</li>
</ul>
<p>Accessing NodePort Service:</p>
<p>as shown by the red line in <code>Figure 2</code>:</p>
<blockquote>
<p>Focus on the scenario where NodePort Service is configured with ExternalTrafficPolicy=Local.</p>
</blockquote>
<ul>
<li>An external client: 1.1.1.1 accesses NodePort: 172.17.1.1:32456. Packets first reach node Node1(172.17.1.1) through external routing</li>
<li>Through the host's Kube-proxy configured iptables DNAT rules, the destination address is rewritten to Macvlan Pod(172.17.1.100), and through the host's table500 routing table, packets are forwarded via vethxx to the target Pod.</li>
<li>
<p>When the Pod sends response packets, seeing destination address 1.1.1.1, it matches the Pod's default route and forwards from eth0, causing communication failure. Spiderpool solves this by setting the following iptables rules and policy routing in the Pod's network namespace, ensuring NodePort traffic received by veth0 is still forwarded to the node via veth0.</p>
<div class="language-text highlight"><pre><span></span><code># pod network namespace
iptables -i veth0 --set-xmark 0x1 ...
~# ip rule 
from all fwmark 0x1 lookup 100
~# ip r show table 100
default dev veth0
</code></pre></div>
</li>
<li>
<p>Through the node's network protocol stack, the packet's source address is changed to the node's IP(172.17.1.1), then through external cluster routing, packets are sent to the client(1.1.1.1), completing the access process.</p>
</li>
</ul>
<h3 id="macvlan-access-to-calico-pod">Macvlan Access to Calico Pod</h3>
<p><img alt="macvlan-calico-pod" src="../../images/macvlan-calico.png" /></p>
<p>There are three main scenarios:</p>
<p>Macvlan Pod accessing Calico Pod on the same node (as shown in <code>Figure 3 Path 1</code>):</p>
<ul>
<li>Macvlan Pod(172.16.100.2) accessing Calico Pod(10.233.100.3/18), packets match Pod routing(<code>10.233.64.0/18 via veth0</code>), forwarding packets from veth0 network card to the node.</li>
<li>Packets match on the node: Calico's virtual route(<code>10.233.100.3 dev calixxx</code>) forwards packets through Calico virtual network card to Calico Pod(10.233.100.3).</li>
<li>Response packets are sent to the node through Calico virtual network card(calixxx), and since the destination address is Macvlan Pod(172.16.100.2), matching route(<code>172.16.100.2 dev vethxxx table 500</code>) forwards to Macvlan Pod, completing the access.</li>
</ul>
<p>Macvlan Pod accessing Calico Pod across nodes (nodes in same subnet, as shown in Figure 3: 2-&gt;2.1):</p>
<ul>
<li>Macvlan Pod(172.16.100.2) accessing Calico Pod(10.233.200.2/18), packets match Pod routing(<code>10.233.64.0/18 via veth0</code>), forwarding packets from veth0 network card to the node.</li>
<li>Through inter-node Calico routing, packets are forwarded to peer node(172.16.1.3). Since the destination address is 10.233.200.2, matching node's Calico route(<code>10.233.100.2 dev calixxx</code>) forwards packets through Calico virtual network card to Calico Pod(10.233.100.2).</li>
<li>Since the original source address is Macvlan Pod(172.16.100.2), Calico Pod will forward response packets first to its local node(172.16.1.3), then directly forward response packets to Macvlan Pod(172.16.100.2) without going through node forwarding, causing inconsistent packet forwarding paths. This may cause the kernel to mark the packet's conntrack state as invalid, leading to packet drop by a kube-proxy iptables rule:<div class="language-text highlight"><pre><span></span><code>  ~# iptables-save  -t filter | grep &#39;--ctstate INVALID -j DROP&#39;
  iptables -A FORWARD -m conntrack --ctstate INVALID -j DROP
</code></pre></div>
</li>
</ul>
<p>This rule was originally implemented to solve the issue raised in <a href="https://github.com/kubernetes/kubernetes/issues/74839">#Issue 74839</a>, where some TCP packets exceeding window limits were marked as invalid conntrack state by the kernel, causing the entire TCP connection to reset. The k8s community addressed this by implementing this rule, but it may affect scenarios with inconsistent packet paths. Related community issues include: <a href="https://github.com/kubernetes/kubernetes/issues/117924">#Issue 117924</a>, <a href="https://github.com/kubernetes/kubernetes/issues/94861">#Issue 94861</a>, <a href="https://github.com/spidernet-io/cni-plugins/issues/177">#Issue 177</a>.</p>
<p>We helped resolve this issue through community collaboration, ultimately fixed in <a href="https://github.com/kubernetes/kubernetes/pull/120412">only drop invalid cstate packets if non liberal</a> for kubernetes version v1.29. We need to ensure each node's sysctl parameter is set: <code>sysctl -w net.netfilter.nf_conntrack_tcp_be_liberal=1</code>, and restart Kube-proxy. This prevents kube-proxy from implementing the drop rule, avoiding impact on communication between single Macvlan pod and single Calico pod.</p>
<p>After execution, check if the drop rule still exists on the node. No output indicates normal operation. Otherwise, check if sysctl is correctly set and if kube-proxy has been restarted.</p>
<div class="language-text highlight"><pre><span></span><code>    ~# iptables-save -t filter | grep &#39;--ctstate INVALID -j DROP&#39;
</code></pre></div>
<blockquote>
<p>Note: Must ensure k8s version is greater than v1.29. If your k8s version is below v1.29, this issue cannot be avoided.</p>
</blockquote>
<h3 id="macvlan-pod-accessing-calico-pods-service">Macvlan Pod Accessing Calico Pod's Service</h3>
<p><img alt="macvlan-calico-service" src="../../images/macvlan-calico-service.png" /></p>
<ul>
<li>
<p>Macvlan Pod(172.16.100.2) inserts a route to intercept service traffic, making Pod access to ClusterIP(10.233.0.100) forward packets through veth0 network card to node Node1(172.16.1.2).</p>
<div class="language-text highlight"><pre><span></span><code>～# ip r
10.233.0.0/18 via 10.7.168.71 dev eth0 src 10.233.100.2
</code></pre></div>
</li>
<li>
<p>After packets are forwarded to node Node1(172.16.1.2), the host network stack's kube-proxy converts clusterip to Calico Pod's IP: 10.233.200.2. Then through Calico's tunnel routing forwards to node Node2(172.16.1.3). Note that when request packets are sent from node3, their source address is SNAT'd to Node1's IP(172.16.1.2). This ensures response packets can return via the same path, avoiding inconsistent routing paths when Macvlan Pod accesses Calico Pod. After request packets are forwarded to host Node2, they are forwarded to Calico Pod(10.233.200.2) through the node's calixxx virtual network card.</p>
</li>
<li>
<p>Calico Pod(10.233.200.2) forwards response packets to node Node2. At this point, the response packet's destination address is node Node1(172.16.1.2), so it's forwarded to Node1 through node routing. Then through Kube-proxy, the destination address is rewritten to Macvlan Pod's IP: 172.16.100.2, and source address to ClusterIP(10.233.0.100). Then matching the host's route table500(<code>172.16.100.2 dev vethxxx table 500</code>), packets are sent to Macvlan Pod, completing the access.</p>
</li>
</ul>
<h3 id="calicomacvlan-multi-nic-pod-accessing-calico-and-macvlan-pods">Calico+Macvlan Multi-NIC Pod Accessing Calico and Macvlan Pods</h3>
<p><img alt="calico-macvlan-pod" src="../../images/macvlan-overlay.png" /></p>
<p>As shown in <code>Figure 4</code>: Node1 runs a Calico-Macvlan Pod (with both calico and macvlan network cards), while Node2 runs a Macvlan Pod (with only macvlan network card) and a Calico Pod (with only calico network card).</p>
<p>Calico + Macvlan Multi-NIC Pod Accessing Calico Pod:</p>
<p>as shown by red line in Figure 4:</p>
<ul>
<li>
<p>Calico-Macvlan Pod has two network cards, Spiderpool coordinates routing between multiple cards, enabling Pod to access both Overlay and Underlay networks.</p>
<div class="language-text highlight"><pre><span></span><code>~# # all routing-table of eth0(calico)
~# ip route show table main
172.16.1.2 dev eth0
10.233.64.0/18 dev eth0
172.16.0.0/16 dev net1
default via 169.254.1.1 dev eth0
~# # all routing-table of net1(macvlan)
~# ip route show table 101
default via 172.16.0.1 dev net1
172.16.0.0/16 dev net1
</code></pre></div>
</li>
<li>
<p>When Calico-Macvlan Pod accesses Calico Pod(10.233.100.4), it matches Pod routing(<code>10.233.64.0/18 dev eth0</code>) and sends packets through eth0 to node Node1(172.16.1.1), with source address being Calico network card's IP(10.233.100.3). Since the destination address is 10.233.100.4, packets are forwarded through inter-node Calico network to node Node2(172.16.1.2), and finally to Calico Pod.</p>
</li>
<li>When Calico Pod sends response packets, the destination address is Calico-Macvlan Pod's calico network card IP(10.233.100.3). This process is similar to communication between Calico Pods, forwarding response packets through Calico node routing to Node1, then through Calico's virtual routing to Calico-Macvlan Pod, completing the access.</li>
</ul>
<p>Calico + Macvlan Multi-NIC Pod Accessing Macvlan Pod</p>
<p>as shown by black line in Figure 4:</p>
<ul>
<li>
<p>Calico-Macvlan Pod has two network cards, Spiderpool coordinates routing between multiple cards, enabling Pod to access both Overlay and Underlay networks simultaneously.</p>
<div class="language-text highlight"><pre><span></span><code>~# # all routing-table of eth0(calico)
~# ip route show table main
172.16.1.2 dev eth0
10.233.64.0/18 dev eth0
default via 169.254.1.1 dev eth0
172.16.0.0/16 dev net1
～# ip route show table 101
~# # all routing-table of net1(macvlan)
~# ip route show table 101
default via 172.16.0.1 dev net1
172.16.0.0/16 dev net1
</code></pre></div>
</li>
<li>
<p>When Calico-Macvlan Pod accesses Macvlan Pod(172.16.100.3), packets match routing(<code>172.16.0.0/16 dev net1</code>) and are sent through Pod's macvlan network card <code>net1</code>.</p>
</li>
<li>Packets are forwarded directly through Underlay network to Node2's Macvlan Pod(172.16.100.3)</li>
<li>When Macvlan Pod(172.16.100.3) sends response packets, since the destination address is 172.16.100.2, packets are sent back to Calico-Macvlan Pod through Underlay network, completing the access.</li>
</ul>
<h3 id="calicomacvlan-multi-nic-pod-accessing-service">Calico+Macvlan Multi-NIC Pod Accessing Service</h3>
<p><img alt="calico-macvlan-service" src="../../images/calico-macvlan-nodeport.png" /></p>
<p>Node1 runs a Macvlan Pod (with only one Macvlan network card: 172.16.100.3) and a Calico Pod (with only one Calico network card: 10.233.100.4).</p>
<p>Calico-Macvlan Multi-NIC Pod Accessing ClusterIP (endpoint using Calico network)</p>
<p>As shown by the blue arrow in <code>Figure 5</code>:</p>
<ul>
<li>According to the routing in the Pod, traffic accessing ClusterIP is forwarded through eth0 to node Node2. Then, the kube-proxy on the node resolves the target clusterip address to the Calico Pod's IP: 10.233.100.4, and forwards it through the node's routing to the target host Node1, finally forwarding it to the Calico Pod through the calixxx virtual network card.</li>
<li>Response packets are forwarded through eth0 to node Node1, with the destination address being the Calico-Macvlan Pod's Calico network card IP: 10.233.100.3. They are then forwarded through inter-node Calico routing to Node2. Subsequently, Node2's kube-proxy rewrites the source address to the clusterip address, and then sends it to the Calico-Macvlan Pod through the calixxx virtual network card, completing the access.</li>
</ul>
<p>Calico-Macvlan Multi-NIC Pod Accessing ClusterIP (endpoint using Macvlan network)</p>
<p>As shown by the red arrow in <code>Figure 5</code>:</p>
<ul>
<li>According to the routing in the Pod, traffic accessing ClusterIP is forwarded through eth0 to node Node2. Then, the kube-proxy on the node resolves the target clusterip address to the Macvlan Pod's IP: 172.16.100.3, and forwards it through inter-node routing to the target host Node1. Note that when packets are sent from Node2, their source address has already been SNAT'd to: 172.16.1.3.</li>
<li>Upon reaching Node1, packets are forwarded through the vethxxx virtual network card, ultimately reaching the Macvlan Pod.</li>
<li>When response packets are sent, since the destination address is Node2's IP, the packets are directly forwarded through eth0 to Node2. After passing through Node2's kube-proxy, the source address is rewritten to the clusterip address, and the destination address is changed to the Calico-Macvlan Pod's Calico IP (10.233.100.3). Finally, the packets are sent to the Calico-Macvlan Pod through the calixxx virtual network card, completing the access.</li>
</ul>
<h3 id="accessing-nodeport-of-calico-macvlan-multi-nic-pod-as-shown-by-the-black-arrow-in-figure-5">Accessing NodePort of Calico-Macvlan Multi-NIC Pod (as shown by the black arrow in <code>Figure 5</code>)</h3>
<ul>
<li>An external client (172.16.1.100) accesses NodePort Service (172.16.1.3:32567). The packets are routed externally to Node2 (172.16.1.3), and through the iptables DNAT rules set by Kube-proxy, the destination address is changed to: 10.233.100.3 (the Calico network card IP of the Pod), and then forwarded to the Pod through the calixxx virtual network card.</li>
<li>When the Pod sends response packets, the destination address is: 172.16.1.100. The response packets are sent directly through net1 (the IP of the Pod's Macvlan network card) to 172.16.1.100. The client receives the packets and finds that the five-tuple does not match, so it discards the packets.</li>
<li>
<p>To resolve this issue caused by asymmetric routing, Spiderpool tunes the policy routing in the Pod to ensure that the response packets to NodePort are sent out from eth0.</p>
<div class="language-text highlight"><pre><span></span><code>~# ip rule
...
from 10.233.100.3 lookup 100
~# ip route show table 100
default via 169.254.1.1 dev eth0
</code></pre></div>
</li>
<li>
<p>After tuning the policy routing, response packets are sent from eth0 to Node2, and through Kube-proxy, the source address is changed to Node2's IP (172.16.1.3), with the destination address being: 172.16.1.100. The response packets are routed externally to 172.16.1.100, completing the access.</p>
</li>
</ul>
<blockquote>
<p>Note: The issue of asymmetric routing when accessing NodePort only exists when the default route of the multi-NIC Pod is on eth0. If the default route is on net1, this issue does not occur.</p>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<p>We have summarized some communication scenarios when these three types of Pods exist in a cluster as follows.</p>
<table>
<thead>
<tr>
<th>Source\Target</th>
<th>Calico Pod</th>
<th>Macvlan Pod</th>
<th>Calico + Macvlan Multi-NIC Pod</th>
<th>Service for Calico Pod</th>
<th>Service for Macvlan Pod</th>
<th>Service for Calico + Macvlan Multi-NIC Pod</th>
</tr>
</thead>
<tbody>
<tr>
<td>Calico Pod</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Macvlan Pod</td>
<td>requires kube-proxy version greater than v1.29.</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Calico + Macvlan Multi NIC Pod</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
</tbody>
</table>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../blog/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Blogs" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Blogs
            </div>
          </div>
        </a>
      
      
        
        <a href="../../usage/spider-multus-config/" class="md-footer__link md-footer__link--next" aria-label="Next: SpiderMultusConfig" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              SpiderMultusConfig
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "search.share"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>
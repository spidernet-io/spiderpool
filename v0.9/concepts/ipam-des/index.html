
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-8.5.10">
    
    
      
        <title>IPAM - spiderpool</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ipam" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../..">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="spiderpool" class="md-header__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spiderpool
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              IPAM
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="spiderpool" class="md-nav__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    spiderpool
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/get-started-kind/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usage/readme/" class="md-nav__link">
        Index
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Underlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Underlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Underlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-weave/" class="md-nav__link">
        Weave
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-macvlan/" class="md-nav__link">
        Macvlan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-ovs/" class="md-nav__link">
        Ovs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/underlay/get-started-sriov/" class="md-nav__link">
        SR-IOV
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Overlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Overlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Overlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/overlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/overlay/get-started-cilium/" class="md-nav__link">
        Cilium
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Public Cloud Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Public Cloud Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Public Cloud Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-alibaba/" class="md-nav__link">
        Alibaba Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-aws/" class="md-nav__link">
        AWS Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-vmware/" class="md-nav__link">
        VWware vSphere
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/cloud/get-started-openstack/" class="md-nav__link">
        OpenStack
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/upgrade/" class="md-nav__link">
        Upgrading
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/uninstall/" class="md-nav__link">
        Uninstalling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/install/system-requirements/" class="md-nav__link">
        System requirements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          IPAM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        IPAM
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ipam-for-underlay-and-overlay-network-solutions" class="md-nav__link">
    IPAM for Underlay and Overlay Network Solutions
  </a>
  
    <nav class="md-nav" aria-label="IPAM for Underlay and Overlay Network Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ipam-for-overlay-networks" class="md-nav__link">
    IPAM for Overlay Networks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipam-for-underlay-networks" class="md-nav__link">
    IPAM for Underlay Networks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spiderpool-ipam" class="md-nav__link">
    Spiderpool IPAM
  </a>
  
    <nav class="md-nav" aria-label="Spiderpool IPAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip-allocation-algorithm" class="md-nav__link">
    IP Allocation Algorithm
  </a>
  
    <nav class="md-nav" aria-label="IP Allocation Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#candidate-pool-acquisition" class="md-nav__link">
    Candidate Pool Acquisition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#candidate-pool-filtering" class="md-nav__link">
    Candidate Pool Filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#candidate-pool-sorting" class="md-nav__link">
    Candidate Pool Sorting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-garbage-collection" class="md-nav__link">
    IP Garbage Collection
  </a>
  
    <nav class="md-nav" aria-label="IP Garbage Collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spiderippool-garbage-collection" class="md-nav__link">
    SpiderIPPool Garbage Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spiderippool-garbage-collection-algorithm" class="md-nav__link">
    SpiderIPPool Garbage Collection Algorithm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip-conflict-detection-and-gateway-reachability-detection" class="md-nav__link">
    IP Conflict Detection and Gateway Reachability Detection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ipam-performance/" class="md-nav__link">
        IPAM Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../coordinator/" class="md-nav__link">
        Plugin coordinator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io-performance/" class="md-nav__link">
        I/O Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blog/" class="md-nav__link">
        Blogs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-multus-config/" class="md-nav__link">
        SpiderMultusConfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-ippool/" class="md-nav__link">
        IPAM of SpiderIPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-affinity/" class="md-nav__link">
        IPAM of IPPool Affinity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/spider-subnet/" class="md-nav__link">
        IPAM of SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/operator/" class="md-nav__link">
        IPAM for operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/statefulset/" class="md-nav__link">
        IPAM for StatefulSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/reserved-ip/" class="md-nav__link">
        IPAM of Reserved IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/multi-interfaces-annotation/" class="md-nav__link">
        MultipleInterfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/egress/" class="md-nav__link">
        Egress Policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/cilium-chaining/" class="md-nav__link">
        Network Policy Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/route/" class="md-nav__link">
        Route Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/network-topology/" class="md-nav__link">
        Node-based Topology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/rdma-roce/" class="md-nav__link">
        RDMA with RoCE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/rdma-ib/" class="md-nav__link">
        RDMA with Infiniband
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/submariner/" class="md-nav__link">
        Multi-Cluster Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/underlay_cni_service/" class="md-nav__link">
        Access Service for Underlay CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/ipvlan_bandwidth/" class="md-nav__link">
        Bandwidth Manage for IPVlan CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/multi_cni_coexist/" class="md-nav__link">
        Coexistence of multi CNIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/kubevirt/" class="md-nav__link">
        Kubevirt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/istio/" class="md-nav__link">
        Istio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/annotation/" class="md-nav__link">
        Annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/configmap/" class="md-nav__link">
        Configmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-controller/" class="md-nav__link">
        spiderpool-controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-agent/" class="md-nav__link">
        spiderpool-agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidersubnet/" class="md-nav__link">
        CRD SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderippool/" class="md-nav__link">
        CRD SpiderIPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidermultusconfig/" class="md-nav__link">
        CRD Spidermultusconfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidercoordinator/" class="md-nav__link">
        CRD Spidercoordinator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderendpoint/" class="md-nav__link">
        CRD SpiderEndpoint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderreservedip/" class="md-nav__link">
        CRD SpiderReservedIP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ifacer/" class="md-nav__link">
        Ifacer plugin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ipam/" class="md-nav__link">
        IPAM plugin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/contributing/" class="md-nav__link">
        Contribution Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/CODE-OF-CONDUCT/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/release/" class="md-nav__link">
        Release workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/swagger_openapi/" class="md-nav__link">
        Swagger OpenAPI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ipam-for-underlay-and-overlay-network-solutions" class="md-nav__link">
    IPAM for Underlay and Overlay Network Solutions
  </a>
  
    <nav class="md-nav" aria-label="IPAM for Underlay and Overlay Network Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ipam-for-overlay-networks" class="md-nav__link">
    IPAM for Overlay Networks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipam-for-underlay-networks" class="md-nav__link">
    IPAM for Underlay Networks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spiderpool-ipam" class="md-nav__link">
    Spiderpool IPAM
  </a>
  
    <nav class="md-nav" aria-label="Spiderpool IPAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip-allocation-algorithm" class="md-nav__link">
    IP Allocation Algorithm
  </a>
  
    <nav class="md-nav" aria-label="IP Allocation Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#candidate-pool-acquisition" class="md-nav__link">
    Candidate Pool Acquisition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#candidate-pool-filtering" class="md-nav__link">
    Candidate Pool Filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#candidate-pool-sorting" class="md-nav__link">
    Candidate Pool Sorting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-garbage-collection" class="md-nav__link">
    IP Garbage Collection
  </a>
  
    <nav class="md-nav" aria-label="IP Garbage Collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spiderippool-garbage-collection" class="md-nav__link">
    SpiderIPPool Garbage Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spiderippool-garbage-collection-algorithm" class="md-nav__link">
    SpiderIPPool Garbage Collection Algorithm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip-conflict-detection-and-gateway-reachability-detection" class="md-nav__link">
    IP Conflict Detection and Gateway Reachability Detection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  <a href="https://github.com/spidernet-io/spiderpool/edit/master/docs/concepts/ipam-des.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="ipam">IPAM</h1>
<p><strong>English</strong> | <a href="../ipam-des-zh_CN/"><strong>简体中文</strong></a></p>
<h2 id="ipam-for-underlay-and-overlay-network-solutions">IPAM for Underlay and Overlay Network Solutions</h2>
<p>There are two technologies in cloud-native networking: "overlay network" and "underlay network". Despite no strict definition for underlay and overlay networks in cloud-native networking, we can simply abstract their characteristics from many CNI projects. The two technologies meet the needs of different scenarios.</p>
<p>Spiderpool is designed for underlay networks, and the following comparison of the two solutions can better illustrate the features and usage scenarios of Spiderpool.</p>
<h3 id="ipam-for-overlay-networks">IPAM for Overlay Networks</h3>
<p>These solutions implement the decoupling of the Pod network and host network, such as <a href="https://github.com/projectcalico/calico">Calico</a>, <a href="https://github.com/cilium/cilium">Cilium</a>, and other CNI plugins. Typically, they use tunnel technology such as vxlan to build an overlay network plane and use NAT technology for north-south traffic.</p>
<p>These IPAM solutions have the following characteristics:</p>
<ol>
<li><strong>Divide Pod subnets into node-based IP blocks</strong></li>
</ol>
<p>In terms of a smaller subnet mask, the Pod subnet is divided into smaller IP blocks, and each node is assigned one or more IP blocks depending on the actual IP allocation account.</p>
<ul>
<li>Since the IPAM plugin on each node only needs to allocate and release IP addresses in the local IP block, there is no IP allocation conflict with IPAM on other nodes, achieving more efficient allocation.</li>
<li>
<p>A specific IP address follows an IP block and is allocated within one node all the time, so it cannot be assigned on other nodes together with a bound Pod.</p>
</li>
<li>
<p><strong>Sufficient IP address resources</strong></p>
</li>
</ul>
<p>Subnets not overlapping with any CIDR could be used by the cluster, so the cluster has enough IP address resources as long as NAT technology is used in an appropriate manner. As a result, IPAM components face less pressure to reclaim abnormal IP addresses.</p>
<ol>
<li><strong>No requirement for static IP addresses</strong></li>
</ol>
<p>For the static IP address requirement, there is a difference between a stateless application and a stateful application. Regarding stateless applications like deployment, the Pod's name will change when the Pod restarts, and the business logic of the application itself is stateless. Thus, static IP addresses mean that all the Pod replicas are fixed in a set of IP addresses. For stateful applications such as statefulset, considering both the fixed information including Pod's names and stateful business logic, the strong binding of one Pod and one specific IP address needs to be implemented for static IP addresses.</p>
<p>The "overlay network solution" mostly exposes the ingress and source addresses of services to the outside of the cluster with the help of NAT technology and realizes the east-west communication through DNS, clusterIP, and other technologies. In addition, although the IP block of IPAM fixes the IP to one node, it does not guarantee the application replicas follow the scheduling. Therefore, there is no scope for the static IP address capability. Most of the mainstream CNIs in the community have not yet supported "static IP addresses" or support it in a rough way.</p>
<p>The advantage of the "overlay network solution" is that the CNI plugins are highly compatible with any underlying network environment and can provide independent subnets with sufficient IP addresses for Pods.</p>
<h3 id="ipam-for-underlay-networks">IPAM for Underlay Networks</h3>
<p>These solutions share the node's network for Pods, which means Pods can directly obtain IP addresses in the node network. Thus, applications can directly use their own IP addresses for east-west and north-south communications.</p>
<p>There are two typical scenarios for underlay network solutions: clusters deployed on a "legacy network" and clusters deployed on an IAAS environment, such as a public cloud. The following summarizes the IPAM characteristics of the "legacy network scenario":</p>
<ol>
<li><strong>An IP address able to be assigned to any node</strong></li>
</ol>
<p>As the number of network devices in the data center increases and multi-cluster technology evolves, IPv4 address resources become scarce, thus requiring IPAM to improve the efficiency of IP usage. As the Pod replicas of the applications requiring "static IP addresses" could be scheduled to any node in the cluster and drift between nodes, IP addresses might drift together.</p>
<p>Therefore, an IP address should be able to be allocated to a Pod on any node.</p>
<ol>
<li><strong>Different replicas within one application could obtain IP addresses across subnets</strong></li>
</ol>
<p>Take as an example one node could access subnet 172.20.1.0/24 while another node just only access subnet 172.20.2.0/24. In this case, when the replicas within one application need to be deployed across subnets, IPAM is required to be able to assign subnet-matched IP addresses to the application on different nodes.</p>
<ol>
<li><strong>Static IP addresses</strong></li>
</ol>
<p>For some traditional applications, the source IPs or destination IPs need to be sensed in the microservice. And network admins are used to enabling fine-grained network security control via firewalls and other means.</p>
<p>Therefore, in order to reduce the transformation chores after the applications move to Kubernetes, applications need static IP addresses.</p>
<ol>
<li><strong>Pods with Multiple NICs need IP addresses of different underlay subnets</strong></li>
</ol>
<p>Since the Pod is connected to an underlay network, it has the need for multiple NICs to reach different underlay subnets.</p>
<ol>
<li><strong>IP conflict</strong></li>
</ol>
<p>Underlay networks are more prone to IP conflicts. For instance, Pods conflict with host IPs outside the cluster, or conflict with other clusters under the same subnet. But it is difficult for IPAM to discover these conflicting IP addresses externally unless CNI plugins are involved for real-time IP conflict detection.</p>
<ol>
<li><strong>Release and recover IP addresses</strong></li>
</ol>
<p>Because of the scarcity of IP addresses in underlay networks and the static IP address requirements of applications, a newly launched Pod may fail due to the lack of IP addresses owing to some IP addresses not being released by abnormal Pods. This requires IPAMs to have a more accurate, efficient, and timely IP recovery mechanism.</p>
<p>The advantages of the underlay network solution include: no need for network NAT mapping, which makes cloud-based network transformation for applications way more convenient; the underlying network firewall and other devices can achieve relatively fine control of Pod communication; no tunneling technology contributes to improved throughput and latency performance of network communications.</p>
<h2 id="spiderpool-ipam">Spiderpool IPAM</h2>
<p>Any CNI project compatible with third-party IPAM plugins can work well with Spiderpool IPAM, such as:</p>
<ul>
<li><a href="https://github.com/containernetworking/plugins/tree/main/plugins/main/macvlan">Macvlan CNI</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/main/plugins/main/vlan">Vlan CNI</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/main/plugins/main/ipvlan">Ipvlan CNI</a></li>
<li><a href="https://github.com/k8snetworkplumbingwg/sriov-cni">SR-IOV CNI</a></li>
<li><a href="https://github.com/k8snetworkplumbingwg/ovs-cni">OVS CNI</a></li>
<li><a href="https://github.com/k8snetworkplumbingwg/multus-cni">Multus CNI</a></li>
<li><a href="https://github.com/projectcalico/calico">Calico CNI</a></li>
<li><a href="https://github.com/weaveworks/weave">Weave CNI</a></li>
</ul>
<p>Spiderpool IPAM is primarily divided into two major modules: allocation and recovery; the overall process is as follows:</p>
<ol>
<li>
<p>When a Pod starts, Spiderpool checks if the corresponding Pod's <code>SpiderEndpoint</code> object exists. If it exists, for StatefulSet applications that have a fixed Pod name and require a fixed IP, Spiderpool will continue to use the IP address recorded in SpiderEndpoint for allocation. For Deployment applications that are stateless, because the Pod name changes with each Pod restart, Spiderpool can only fix the IP within a certain range and will reassign an IP address to the Pod through an allocation algorithm, synchronizing the updated Pod information to the IP pool and SpiderEndpoint. If it does not exist, Spiderpool will allocate an IP address to the Pod through an allocation algorithm (getting candidate pools -&gt; filtering candidate pools -&gt; sorting candidate pools), and simultaneously create a <code>SpiderEndpoint</code> object corresponding to the Pod, which records the IP address, UID, and other information used by the Pod. It will also carry a finalizer and be set as an <code>OwnerReference</code> along with the Pod.</p>
</li>
<li>
<p>Spiderpool ensures the robustness of IP addresses through two methods. First, Spiderpool's Informer mechanism tracks the lifecycle of Pods. Second, it periodically scans the IP status of IPPool within the global default interval. For StatefulSet applications that require fixed IP addresses, as long as their Pod replicas are valid, Spiderpool will not reclaim their IP addresses and SpiderEndpoint objects, allowing them to consistently obtain the same IP address. For invalid StatefulSet applications and Deployment applications that are stateless, their IP addresses and SpiderEndpoint objects will be reclaimed.</p>
</li>
</ol>
<p><img alt="Spiderpool IPAM Allocation and Reclaim" src="../../images/ipam-concepts.jpg" /></p>
<h3 id="ip-allocation-algorithm">IP Allocation Algorithm</h3>
<p>When creating a Pod, it will follow the steps below to get IP allocations. The lifecycle of IP allocation involves three major stages: <code>candidate pool acquisition</code>, <code>candidate pool filtering</code>, and <code>candidate pool sorting</code>.</p>
<ul>
<li>
<p><strong>Candidate pool acquisition</strong>: Spiderpool follows a strict rule of selecting pools from <strong>high to low priority</strong>. It identifies all pools that match <strong>the high priority rules</strong> and marks them as candidates for further consideration.</p>
</li>
<li>
<p><strong>Candidate pool filtering</strong>: Spiderpool applies filtering mechanisms such as affinity to carefully select the appropriate candidate pools from the available options. This ensures that specific requirements or complex usage scenarios are satisfied.</p>
</li>
<li>
<p><strong>Candidate pool sorting</strong>: In cases where multiple candidate pools exist, Spiderpool sorts them based on the priority rules defined in the SpiderIPPool object. IP addresses are then allocated sequentially, starting from the pool with available addresses.</p>
</li>
</ul>
<h4 id="candidate-pool-acquisition">Candidate Pool Acquisition</h4>
<p>Spiderpool offers a variety of pool selection rules when assigning IP addresses to Pods. The selection process strictly adheres to a <strong>high to low priority</strong> order. The following rules are listed in <strong>descending order of priority</strong>, and if multiple rules apply at the same time, the preceding rule will <strong>overwrite</strong> the subsequent one.</p>
<ol>
<li><strong>The 1st priority: SpiderSubnet annotation</strong></li>
</ol>
<p>The SpiderSubnet resource represents a collection of IP addresses. When an application requires a fixed IP address, the application administrator needs to inform their platform counterparts about the available IP addresses and routing attributes. However, as they belong to different operational departments, this process becomes cumbersome, resulting in complex workflows for creating each application. To simplify this, Spiderpool's SpiderSubnet feature automatically allocates IP addresses from subnets to IPPool and assigns fixed IP addresses to applications. This greatly reduces operational costs. When creating an application, you can use the <code>ipam.spidernet.io/subnets</code> or <code>ipam.spidernet.io/subnet</code> annotation to specify the Subnet. This allows for the automatic creation of an IP pool by randomly selecting IP addresses from the subnet, which can then be allocated as fixed IPs for the application. For more details, please refer to <a href="../../usage/spider-subnet/">SpiderSubnet</a>.</p>
<ol>
<li><strong>The 2nd priority: SpiderIPPool annotation</strong></li>
</ol>
<p>Different IP addresses within a Subnet can be stored in separate instances of IPPool (Spiderpool ensures that there is no overlap between the address sets of IPPools). The size of the IP collection in SpiderIPPool can vary based on requirements. This design feature is particularly beneficial when dealing with limited IP address resources in the Underlay network. When creating an application, the SpiderIPPool annotation <code>ipam.spidernet.io/ippools</code> or <code>ipam.spidernet.io/ippool</code> can be used to bind different IPPools or share the same IPPool. This allows all applications to share the same Subnet while maintaining "micro-isolation". For more details, please refer to <a href="../../reference/annotation/">SpiderIPPool annotation</a>.</p>
<ol>
<li><strong>The 3rd priority: Namespace default IP pool</strong></li>
</ol>
<p>By setting the annotation <code>ipam.spidernet.io/default-ipv4-ippool</code> or <code>ipam.spidernet.io/default-ipv6-ippool</code> in the namespace, you can specify the default IP pool. When creating an application within that tenant, if there are no other higher-priority pool rules, it will attempt to allocate an IP address from the available candidate pools for that tenant. For more details, please refer to <a href="../../reference/annotation/">Namespace Annotation</a>.</p>
<ol>
<li><strong>The 4th priority: CNI configuration file</strong></li>
</ol>
<p>The global CNI default pool can be set by configuring the <code>default_ipv4_ippool</code> and <code>default_ipv6_ippool</code> fields in the CNI configuration file. Multiple IP pools can be defined as alternative pools. When an application uses this CNI configuration network and invokes Spiderpool, each application replica is sequentially assigned an IP address according to the order of elements in the "IP pool array". In scenarios where nodes belong to different regions or data centers, if the node where an application replica is scheduled matches the node affinity rule of the first IP pool, the Pod obtains an IP from that pool. If it doesn't meet the criteria, Spiderpool attempts to assign an IP from the alternative pools until all options have been exhausted. For more information, please refer to <a href="../../reference/plugin-ipam/">CNI Configuration</a>.</p>
<ol>
<li><strong>The 5th priority: Cluster's default IP pool</strong></li>
</ol>
<p>Within the SpiderIPPool CR object, setting the <strong>spec.default</strong> field to <code>true</code> designates the pool as the cluster's default IP pool (default value is <code>false</code>). For more information, please refer to <a href="../../reference/crd-spiderippool/">Cluster's Default IP Pool</a>.</p>
<h4 id="candidate-pool-filtering">Candidate Pool Filtering</h4>
<p>To determine the availability of candidate IP pools for IPv4 and IPv6, Spiderpool filters them using the following rules:</p>
<ul>
<li>IP pools in the <code>terminating</code> state are filtered out.</li>
<li>The <code>spec.disable</code> field of an IP pool indicates its availability. A value of <code>true</code> means the IP pool is not usable.</li>
<li>Check if the <code>IPPool.Spec.NodeName</code> and <code>IPPool.Spec.NodeAffinity</code> match the Pod's scheduling node. Mismatching values result in filtering out the IP pool.</li>
<li>Check if the <code>IPPool.Spec.NamespaceName</code> and <code>IPPool.Spec.NamespaceAffinity</code> match the Pod's namespace. Mismatching values lead to filtering out the IP pool.</li>
<li>Check if the <code>IPPool.Spec.NamespaceName</code> matches the Pod's <code>matchLabels</code>. Mismatching values lead to filtering out the IP pool.</li>
<li>Check if the <code>IPPool.Spec.MultusName</code> matches the current NIC Multus configuration of the Pod. If there is no match, the IP pool is filtered out.</li>
<li>Check if all IPs within the IP pool are included in the IPPool instance's <code>exclude_ips</code> field. If it is, the IP pool is filtered out.</li>
<li>Check if all IPs in the pool are reserved in the ReservedIP instance. If it is, the IP pool is filtered out.</li>
<li>An IP pool will be filtered out if its available IP resources are exhausted.</li>
</ul>
<h4 id="candidate-pool-sorting">Candidate Pool Sorting</h4>
<p>After filtering the candidate pools, Spiderpool may have multiple pools remaining. To determine the order of IP address allocation, Spiderpool applies custom priority rules to sort these candidates. IP addresses are then selected from the pools with available IPs in the following manner:</p>
<ul>
<li>IP pool resources with the <code>IPPool.Spec.PodAffinity</code> property are given the highest priority.</li>
<li>IPPool resources with either the <code>IPPool.Spec.NodeName</code> or <code>IPPool.Spec.NodeAffinity</code> property are given the secondary priority. The <code>NodeName</code> takes precedence over <code>NodeAffinity</code>.</li>
<li>Following that, IP pool resources with either the <code>IPPool.Spec.NamespaceName</code> or <code>IPPool.Spec.NamespaceAffinity</code> property maintain the third-highest priority. The <code>NamespaceName</code> takes precedence over <code>NamespaceAffinity</code>.</li>
<li>IP pool resources with the <code>IPPool.Spec.MultusName</code> property receive the lowest priority.</li>
</ul>
<blockquote>
<p>Here are some simple instances to describe this rule.</p>
<ol>
<li><em>IPPoolA</em> with properties <code>IPPool.Spec.PodAffinity</code> and <code>IPPool.Spec.NodeName</code> has higher priority than <em>IPPoolB</em> with a single affinity property <code>IPPool.Spec.PodAffinity</code>.</li>
<li><em>IPPoolA</em> with a single property <code>IPPool.Spec.PodAffinity</code> has higher priority than <em>IPPoolB</em> with properties <code>IPPool.Spec.NodeName</code> and <code>IPPool.Spec.NamespaceName</code>.</li>
<li><em>IPPoolA</em> with properties <code>IPPool.Spec.PodAffinity</code> and <code>IPPool.Spec.NodeName</code> has higher priority than <em>IPPoolB</em> with properties <code>IPPool.Spec.PodAffinity</code>, <code>IPPool.Spec.NamespaceName</code>, and <code>IPPool.Spec.MultusName</code>.</li>
</ol>
<p>If a Pod belongs to StatefulSet, IP addresses that meet the aforementioned rules will be allocated with priority. When a Pod is restarted, it will attempt to reuse the previously assigned IP address.</p>
</blockquote>
<h2 id="ip-garbage-collection">IP Garbage Collection</h2>
<h3 id="context">Context</h3>
<p>When a pod is normally deleted, the CNI plugin will be called to clean IP on a pod interface and make IP free on the IPAM database. This can make sure all IPs are managed correctly and no IP leakage issue occurs.</p>
<p>But in some cases, it may go wrong and the IP of the IPAM database is still marked as used by a nonexistent pod.</p>
<p>When some errors happen, the CNI plugin is not called correctly when pod deletion. This could happen in cases like:</p>
<ul>
<li>When a CNI plugin is called, its network communication goes wrong and fails to release IP.</li>
<li>The container runtime goes wrong and fails to call the CNI plugin.</li>
<li>A node breaks down and then always cannot recover, the api-server makes pods of the breakdown node to be in <code>deleting</code> status, but the CNI plugin fails to be called.</li>
</ul>
<p>BTW, this fault could be simply simulated by removing the CNI binary on a host when pod deletion.</p>
<p>This issue will make a bad result:</p>
<ul>
<li>The new pod may fail to run because the expected IP is still occupied.</li>
<li>The IP resource is exhausted gradually although the actual number of pods does not grow.</li>
</ul>
<p>Some CNI or IPAM plugins could not handle this issue. For some CNIs, the administrator self needs to find the IP with this issue and use a CLI tool to reclaim them. For some CNIs, it runs an interval job to find the IP with this issue and not reclaim them in time. For some CNIs, there is not any mechanism at all to fix the IP issue.</p>
<h3 id="solution">Solution</h3>
<p>For some CNIs, its IP CIDR is big enough, so the leaked IP issue is not urgent. For Spiderpool, all IP resources are managed by the administrator, and an application will be bound to a fixed IP, so the IP reclaim can be finished in time.</p>
<h3 id="spiderippool-garbage-collection">SpiderIPPool Garbage Collection</h3>
<p>To prevent IP from leaking when the ippool resource is deleted, Spiderpool has some rules:</p>
<ul>
<li>For an ippool, if IP is still taken by pods, Spiderpool uses webhook to reject the deleting request of the ippool resource.</li>
<li>For a deleting ippool, the IPAM plugin will stop assigning IP from it but could release IP from it.</li>
<li>The ippool sets a finalizer by the spiderpool controller once it is created. After the ippool goes to <code>deleting</code> status, the spiderpool controller will remove the finalizer when all IPs in the ippool are free, then the ippool object will be deleted.</li>
<li>When a pod is deleted, Spiderpool will release its IPs with the recorded data by a corresponding <code>SpiderEndpoint</code> object, then the spiderpool controller will remove the <code>Current</code> data of the SpiderEndpoint object and remove its finalizer. (For the StatefulSet <code>SpiderEndpoint</code>, Spiderpool will delete it directly if its <code>Current</code> data was cleaned up)</li>
</ul>
<h3 id="spiderippool-garbage-collection-algorithm">SpiderIPPool Garbage Collection Algorithm</h3>
<p>In Kubernetes, garbage collection (GC for short) is crucial for recycling IP addresses. The availability of IP addresses is critical to whether a Pod can start successfully. The GC mechanism can automatically reclaim these unused IP addresses, avoiding waste of resources and exhaustion of IP addresses. The IP information assigned to the Pod will be recorded in IPAM, but when these Pods no longer exist in the Kubernetes cluster, these IPs that are still recorded in IPAM can be called <code>zombie IPs</code>. Spiderpool has the following two recycling methods for <code>zombie IPs</code>:</p>
<ol>
<li>Real-time tracking of Pod events to determine whether the IP address and its corresponding SpiderEndpoint object need to be recycled.</li>
<li>Periodically scan the robustness of the IP pool based on the interval defined by the environment variable <code>SPIDERPOOL_GC_DEFAULT_INTERVAL_DURATION</code> (the default is 10 minutes).</li>
</ol>
<p>The above complete IP recovery algorithm can ensure the correct recovery of IP addresses in all scenarios, including the following special scenarios:</p>
<ul>
<li>
<p>When <code>deleting Pod</code> in the cluster, but due to problems such as <code>network exception</code> or <code>cni binary crash</code>, the call to <code>cni delete</code> fails, resulting in the IP address not being reclaimed by cni.</p>
</li>
<li>
<p>In failure scenarios such as <code>cni delete failure</code>, if a Pod that has been assigned an IP is destroyed, but the IP address is still recorded in the IPAM, a phenomenon of zombie IP is formed. For this kind of problem, Spiderpool will automatically recycle these zombie IP addresses based on the cycle and event scanning mechanism.</p>
</li>
<li>
<p>In some accidents, the <strong>stateless</strong> Pod is in a constant <code>Terminating</code> phase, Spiderpool will automatically release its IP address after the Pod's <code>spec.terminationGracePeriodSecond</code> + <a href="../../reference/spiderpool-controller/#env">spiderpool-controller ENV</a> <code>SPIDERPOOL_GC_ADDITIONAL_GRACE_DELAY</code> periods. This feature can be controlled by the environment variable <code>SPIDERPOOL_GC_STATELESS_TERMINATING_POD_ON_READY_NODE_ENABLED</code>. This capability can be used to solve the failure scenario of <code>unexpected Pod downtime with Node ready</code>.</p>
</li>
<li>
<p>After a node goes down unexpectedly, the Pod in the cluster is permanently in the <code>Terminating</code> phase, and the IP address occupied by the Pod cannot be released.</p>
</li>
<li>
<p>For the <strong>stateless</strong> Pod in the <code>Terminating</code> phase, Spiderpool will automatically release its IP address after the Pod's <code>spec.terminationGracePeriodSecond</code>. This feature can be controlled by the environment variable <code>SPIDERPOOL_GC_STATELESS_TERMINATING_POD_ON_NOT_READY_NODE_ENABLED</code>. This capability can be used to solve the failure scenario of <code>unexpected node downtime</code>.</p>
</li>
<li>
<p>For the <strong>stateless</strong> Pod in the <code>Running</code> phase, Spiderpool will not release its IP address when the Pod's <code>status.podIPs</code> is empty. This feature can be controlled by the environment variable <code>SPIDERPOOL_GC_ENABLE_STATELESS_RUNNING_POD_ON_EMPTY_POD_STATUS_IPS</code>.</p>
</li>
</ul>
<h3 id="ip-conflict-detection-and-gateway-reachability-detection">IP Conflict Detection and Gateway Reachability Detection</h3>
<p>For Underlay networks, IP conflicts are unacceptable as they can cause serious issues. Spiderpool supports IP conflict detection and gateway reachability detection, which were previously implemented by the coordinator plugin but could cause some potential communication problems. Now, this is handled by IPAM.</p>
<p>You can enable or disable this feature through the spiderpool-conf ConfigMap:</p>
<div class="language-text highlight"><pre><span></span><code>  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: spiderpool-conf
    namespace: spiderpool
  data:
    conf.yml: |
     ...
     enableIPConflictDetection: true
     enableGatewayDetection: true
     ...
</code></pre></div>
<ul>
<li>
<p>When IP conflict detection is enabled, Spiderpool will detect if the assigned IP address conflicts with others in the subnet by sending ARP or NDP packets. If a conflict is detected, Pod creation will be blocked. This supports both IPv4 and IPv6.</p>
</li>
<li>
<p>If sending ARP or NDP probe packets fails, it will retry 3 times, and if all attempts fail, an error will be returned.</p>
</li>
<li>If the probe packet is successfully sent and a response is received within 100ms, it indicates an IP conflict.</li>
<li>If a network timeout error is received, it is considered non-conflicting.</li>
<li>
<p>When gateway reachability detection is enabled, Spiderpool will detect if the Pod's gateway address is reachable by sending ARP or NDP packets. If the gateway address is unreachable, Pod creation will be blocked.</p>
</li>
<li>
<p>If sending ARP or NDP probe packets fails, it will retry 3 times, and if all attempts fail, an error will be returned.</p>
</li>
<li>If the probe packet is successfully sent and a response is received within 100ms, it indicates the gateway address is reachable.</li>
<li>If no response is received, it indicates the gateway address is unreachable.</li>
<li>Note: Some switches do not allow ARP probing and will issue alerts. In such cases, you need to set enableGatewayDetection to false.</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../arch/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Architecture" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Architecture
            </div>
          </div>
        </a>
      
      
        
        <a href="../ipam-performance/" class="md-footer__link md-footer__link--next" aria-label="Next: IPAM Performance" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              IPAM Performance
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "search.share"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>